name: Release and Version Management

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  validate:
    name: Validar Script
    runs-on: ubuntu-latest
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Instalar shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Validar sintaxe bash
        run: |
          bash -n distro.sh
          echo "âœ… Sintaxe vÃ¡lida"

      - name: AnÃ¡lise estÃ¡tica com ShellCheck
        run: |
          shellcheck -x distro.sh || true
          echo "âœ… ShellCheck concluÃ­do"

      - name: Verificar permissÃµes de execuÃ§Ã£o
        run: |
          if [ ! -x distro.sh ]; then
            echo "âš ï¸  Arquivo nÃ£o Ã© executÃ¡vel, corrigindo..."
            chmod +x distro.sh
          else
            echo "âœ… PermissÃµes corretas"
          fi

  version-check:
    name: Verificar VersÃ£o
    runs-on: ubuntu-latest
    needs: validate
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      has_tag: ${{ steps.check_tag.outputs.has_tag }}
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Obter versÃ£o do script
        id: get_version
        run: |
          # Extrair versÃ£o do script se houver
          VERSION=$(grep -oP 'DISTRO_VERSION=.*entry-text="\K[^"]+' distro.sh || echo "1.0")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ VersÃ£o detectada: $VERSION"

      - name: Verificar se Ã© tag
        id: check_tag
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            echo "has_tag=true" >> $GITHUB_OUTPUT
            echo "ðŸ·ï¸  Tag detectada: $GITHUB_REF"
          else
            echo "has_tag=false" >> $GITHUB_OUTPUT
            echo "ðŸ“ Push normal (sem tag)"
          fi

  create-release:
    name: Criar Release
    runs-on: ubuntu-latest
    needs: [validate, version-check]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extrair informaÃ§Ãµes da tag
        id: tag_info
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ·ï¸  Tag: $TAG | VersÃ£o: $VERSION"

      - name: Gerar changelog
        id: changelog
        run: |
          PREVIOUS_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            CHANGELOG="## ðŸŽ‰ Primeira Release\n\n$(git log --pretty=format:'- %s (%h)' | head -20)"
          else
            CHANGELOG="## ðŸ“ MudanÃ§as desde $PREVIOUS_TAG\n\n$(git log $PREVIOUS_TAG..HEAD --pretty=format:'- %s (%h)')"
          fi
          
          echo "$CHANGELOG" > CHANGELOG.md
          echo "ðŸ“„ Changelog gerado"

      - name: Criar arquivo de release
        run: |
          mkdir -p release
          cp distro.sh release/
          cp README.md release/
          
          # Criar script de instalaÃ§Ã£o rÃ¡pida
          cat > release/install.sh << 'EOF'
#!/bin/bash
echo "ðŸš€ Instalando MyDistroLinux Builder..."
wget -O distro.sh https://github.com/${{ github.repository }}/releases/latest/download/distro.sh
chmod +x distro.sh
echo "âœ… InstalaÃ§Ã£o concluÃ­da!"
echo "Execute: ./distro.sh"
EOF
          chmod +x release/install.sh

      - name: Criar arquivo ZIP
        run: |
          cd release
          zip -r ../mydistrolinux-${{ steps.tag_info.outputs.version }}.zip .
          cd ..
          echo "ðŸ“¦ Arquivo ZIP criado"

      - name: Criar Release no GitHub
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag_info.outputs.tag }}
          name: MyDistroLinux ${{ steps.tag_info.outputs.version }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: false
          files: |
            distro.sh
            README.md
            mydistrolinux-${{ steps.tag_info.outputs.version }}.zip
            release/install.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Desabilitado por enquanto - usar release.sh manual ou tags manuais
  # auto-version:
  #   name: Auto Incrementar VersÃ£o
  #   runs-on: ubuntu-latest
  #   needs: validate
  #   if: github.ref == 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/')
  #   steps:
  #     - name: Checkout cÃ³digo
  #       uses: actions/checkout@v4

  docker-test:
    name: Testar em Container
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Testar dependÃªncias
        run: |
          echo "ðŸ§ª Testando instalaÃ§Ã£o de dependÃªncias..."
          docker run --rm ubuntu:24.04 bash -c "
            apt-get update && 
            apt-get install -y \
              debootstrap \
              squashfs-tools \
              xorriso \
              isolinux \
              syslinux-utils \
              grub-pc-bin \
              grub-efi-amd64-bin \
              mtools \
              zenity && 
            echo 'âœ… Todas as dependÃªncias instaladas com sucesso'
          "

  notify:
    name: Notificar Status
    runs-on: ubuntu-latest
    needs: [validate, version-check]
    if: always()
    steps:
      - name: Resumo do workflow
        run: |
          echo "## ðŸ“Š Resumo do CI/CD" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch/Tag**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Autor**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ValidaÃ§Ã£o**: ${{ needs.validate.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **VersÃ£o**: ${{ needs.version-check.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Pipeline concluÃ­do!" >> $GITHUB_STEP_SUMMARY
