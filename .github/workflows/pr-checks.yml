name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - dev

jobs:
  validate:
    name: Validate Script
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Bash Syntax Check
        run: |
          bash -n distro.sh
          echo "‚úÖ Script validado sem erros de sintaxe"
      
      - name: ShellCheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
          shellcheck -x distro.sh || echo "‚ö†Ô∏è ShellCheck encontrou avisos (n√£o cr√≠tico)"
  
  check-docs:
    name: Check Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify documentation files
        run: |
          echo "Verificando arquivos de documenta√ß√£o..."
          
          required_files=(
            "README.md"
            "REPOSITORIES.md"
            "TROUBLESHOOTING.md"
            "SUDO-CONFIG.md"
            "VAGRANT.md"
            "CONTRIBUTING.md"
            "CHANGELOG.md"
          )
          
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "‚úÖ $file encontrado"
            else
              echo "‚ùå $file n√£o encontrado"
              exit 1
            fi
          done
          
          echo "‚úÖ Todos os arquivos de documenta√ß√£o est√£o presentes"
      
      - name: Check for broken links in README
        run: |
          echo "Verificando links no README.md..."
          
          # Verificar se arquivos referenciados existem
          grep -o '\[.*\](.*\.md)' README.md | sed 's/.*(\(.*\))/\1/' | while read -r file; do
            if [ -f "$file" ]; then
              echo "‚úÖ Link v√°lido: $file"
            else
              echo "‚ùå Link quebrado: $file"
              exit 1
            fi
          done || exit 0
          
          echo "‚úÖ Links verificados"
  
  size-check:
    name: Check Script Size
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check script complexity
        run: |
          lines=$(wc -l < distro.sh)
          echo "üìä Script tem $lines linhas"
          
          if [ "$lines" -gt 1500 ]; then
            echo "‚ö†Ô∏è Script est√° ficando grande, considere modulariza√ß√£o"
          else
            echo "‚úÖ Tamanho do script aceit√°vel"
          fi
  
  pr-comment:
    name: Comment on PR
    runs-on: ubuntu-latest
    needs: [validate, check-docs]
    if: always()
    permissions:
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const validate = '${{ needs.validate.result }}';
            const checkDocs = '${{ needs.check-docs.result }}';
            
            let emoji = '‚úÖ';
            let status = 'Todas as verifica√ß√µes passaram!';
            
            if (validate !== 'success' || checkDocs !== 'success') {
              emoji = '‚ùå';
              status = 'Algumas verifica√ß√µes falharam.';
            }
            
            const comment = `## ${emoji} Status das Verifica√ß√µes
            
            | Verifica√ß√£o | Status |
            |-------------|--------|
            | Valida√ß√£o do Script | ${validate === 'success' ? '‚úÖ Passou' : '‚ùå Falhou'} |
            | Documenta√ß√£o | ${checkDocs === 'success' ? '‚úÖ Passou' : '‚ùå Falhou'} |
            
            **${status}**
            
            ---
            
            ### üìã Checklist do Revisor
            
            - [ ] C√≥digo segue padr√µes do projeto
            - [ ] Documenta√ß√£o atualizada
            - [ ] Sem warnings cr√≠ticos no ShellCheck
            - [ ] Testado localmente ou no Vagrant
            - [ ] CHANGELOG.md atualizado (se release)
            `;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
